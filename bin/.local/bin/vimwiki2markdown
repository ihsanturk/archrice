#!/bin/sh

[ "$1" = "" ] &&
	>&2 echo "`basename $0`: usage: `basename $0` <target_directory>" && exit 2
[ -d $1 ] || >&2 echo "`basename $0`: $1: no such directory" || exit 2
[ -d `echo $1 | sed -e 's/^\([^/]*\)/\1.markdown/'` ] &&
	>&2 echo "`basename $0`: $1: directory already exists" && exit 2
sourcedir=$1

vimwiki2markdown() {
	local regex='''
	s/# \(.*\)$/* \1/g; s/^= \(.*\) =$/# \1/g; s/^== \(.*\) ==$/## \1/g;
	s/^=== \(.*\) ===$/### \1/g; s/^==== \(.*\) ====$/#### \1/g;
	s/^===== \(.*\) =====$/##### \1/g; s/^====== \(.*\) ======$/###### \1/g;
	s/{{{class="brush: *\([^"]*\)"/\`\`\`\1/g; s/{{{class="\([^"]*\)"/\`\`\`\1/g;
	s/{{{/\`\`\`/g; s/}}}/\`\`\`/g;
	s/\[\(https\{0,1\}:\/\/[^ ]*\) \([^]]*\)\]/[\2](\1)/g;
	s/\[\[\(\(http[^|]\{1,\}\)\|\)\([^]]\{1,\}\)\]\]/[\3](\2)/g;
	s/\[\[\(\([^|]\{1,\}\)\|\)\([^]]\{1,\}\)\]\]/[\3](\2.md)/g;
	s/\[\[\([^]]\{1,\}\)\]\]/[\1](\1.md)/g;
	s/%% \(.*\)/<!-- \1 -->/g; /%toc.*/d; s/%title \(.*\)/# \1/g;
	s/%nohtml/- status: draft/g;'''
	sed "$regex"
}

# Create target dir structure.
find $sourcedir -type d | sed -e 's/^\([^/]*\)/\1.markdown/g' | xargs mkdir -p

# Replace with sed and save to new location
sourcedir=Wiki #TODO DELETE
find $sourcedir -name "*.wiki" | while read file; do
	target=`echo $file|sed -e's/^\([^/]*\)/\1.markdown/g;s/\.wiki$/.md/g'`
	cat $file | vimwiki2markdown > "$target"
done
