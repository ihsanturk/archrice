#!/bin/sh

url_login_nevres="\
http://ns1.google.net/login?dst=http%3A%2F%2Fns1.google.com%2F&popup=false"
url_logout_nevres="http://ns1.google.net/logout"
url_login_ksu='http://10.14.1.223/captive/control.php'
url_logout_ksu=
file_cache=$HOME/.secret.credentials
. $file_cache

usage_message='[ -n | -k ] [ -i | -o ]'
usage() {
	>&2 echo "usage: `basename $0` $usage_message";
}
get_credentials() {
	local ref_username=$1 # TODO FIX: wanna use -n option but couldn't
	local ref_password=$2 # TODO FIX: so that is not working.
	read -p "Username: " ref_username
	read -sp "Password: " ref_password
}
ip() {
	ifconfig | grep -o 'inet \S*' | sed '/127\.0\.0/d' | grep -o '[0-9\.]\+'
}

login=true
logout=false
use_ksu=false
use_nevres=true

# Args
while getopts :nkio args; do
	case $args in
		(k) use_ksu=true; use_nevre=false;;
		(n) use_nevres=true;;
		(i) login=true;;
		(o) logout=true;;
		(h) usage; exit 0;;
		([?]) usage; exit 2;;
	esac
done

# Action
if $login; then
	if $use_nevres; then
		if [[ "$username_nevres" == "" ]] || [[ "$password_nevres" == "" ]]; then
			get_credentials username_nevres password_nevres
			echo
			read -p "Would you like to save the credentials [Y/n]: " cache
			case $cache in
				[Nn]* )
					echo Not saved.
					;;
				* )
					echo export username_nevres=$username_nevres >> $file_cache
					echo export password_nevres=$password_nevres >> $file_cache
					;;
			esac
		else
			curl -s \
"${url_login_nevres}&username=${username_nevres}&password=${password_nevres}" \
				--compressed | grep -o "logged in" 2>&1 >/dev/null &&
					echo Success || echo Fail
		fi
	fi
	if $use_ksu; then
		if [[ "$username_ksu" == "" ]] || [[ "$password_ksu" == "" ]]; then
			get_credentials username_ksu password_ksu
			echo
			read -p "Would you like to save the credentials [Y/n]: " cache
			case $cache in
				[Nn]* )
					echo Not saved.
					;;
				* )
					echo export username_ksu=$username_ksu >> $file_cache
					echo export password_ksu=$password_ksu >> $file_cache
					;;
			esac
		else
			curl -sX POST $url_login_ksu \
				-H 'X-Requested-With:XMLHttpRequest' \
				--data-binary "fingerprint=2866853015&devicetype=Sophos&clientip=`ip`&hostname=10.16.10.3&actinput=221cdfb73049678e244380b45872cbb2&app=MA6678&username=$username_ksu&password=$password_ksu" &&
					echo Success || echo Fail
		fi
	fi
elif $logout; then
	if $use_nevres; then
		curl -s ${url_logout_nevres} |
			grep -o "logged out" 2>&1 >/dev/null && echo Success || echo Fail
	fi
	if $use_ksu; then
		echo #TODO Logout with curl
	fi
fi
